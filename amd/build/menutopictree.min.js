define(["jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(a,b,c,d,e){var f={codeSelector:"#id_treecode",containerSelector:"#treecontainer"},g=[],h=null,i=null;return f.init=function(){var c=f.loadTreeAria(),j=[{key:"new"},{key:"delete"},{key:"actiondeleteconfirm_sheet_sheetedit",component:"format_menutopic"},{key:"yes"},{key:"no"},{key:"update"}];if(a.each(j,function(a,b){g[b.key]="..."}),b.get_strings(j).done(function(b){a.each(j,function(a,c){g[c.key]=b[a]})}),c){var k=a("#editsheetform").html();return d.create({type:d.types.SAVE_CANCEL,title:g.update,body:k}).done(function(a){var b=a.getBody();b.find("#select_topic").on("change",f.changeTopic),a.getRoot().on(e.save,function(){i.find("input").val(b.find("#name_text").val()),i.data("topic",b.find("#select_topic").val()),i.data("url",b.find("#url_text").val()),i.data("target",b.find("#select_target").val())}),h=a}),a("#id_submitbutton").on("click",f.saveTreeConfig),!0}},f.runAction=function(b,d){switch(b){case"toleft":var e=d.parents("li:first");e.after(d);var j=e.children("ul");0==j.children()&&j.remove();break;case"toright":var k=d.prev("li"),j=k.children("ul");0==j.length&&(j=a('<ul role="group"></ul>'),k.append(j)),j.append(d);break;case"todown":var l=d.next("li");l.after(d);break;case"toup":var k=d.prev("li");k.before(d);break;case"toremove":c.confirm(g["delete"],g.actiondeleteconfirm_sheet_sheetedit,g.yes,g.no,function(){d.remove()});break;case"toadd":var m={name:g["new"],topicnumber:0,url:"",target:""},n=f.newTreeNode(m,"");n.find("[data-action]").on("click",function(){var b=a(this);f.runAction(b.attr("data-action"),b.parent().parent())});var j=d.children("ul");0==j.length&&(j=a('<ul role="group"></ul>'),d.append(j)),j.append(n);break;case"toedit":if(i=d,h){var o=h.getBody();o.find("#name_text").val(d.find("input").val()),o.find("#select_topic").val(d.data("topic")),o.find("#url_text").val(d.data("url")),o.find("#select_target").val(d.data("target")),f.changeTopic(),h.setTitle(g.update),h.show()}}},f.newTreeNode=function(b){var c=a('<li><input value="'+b.name+'"/><div class="operations"><span data-action="toedit">&#9997;</span><span data-action="toleft">&larr;</span><span data-action="toright">&rarr;</span><span data-action="toup">&uarr;</span><span data-action="todown">&darr;</span><span data-action="toremove">&#10008;</span><span data-action="toadd">&#10010;</span></div></li>');return c.data("topic",b.topicnumber),c.data("url",b.url),c.data("target",b.target),c},f.loadTreeAria=function(){var d=a(f.codeSelector);if(d.length>0){var e=d.val();try{var g=JSON.parse(e);if(g.topics&&g.topics.length>0){for(var h=function(b,c){var d=!1;c.subtopics&&c.subtopics.length>0&&(d=!0);var e=f.newTreeNode(c);if(b.append(e),d){var g=a("<ul></ul>");e.append(g);for(var i=0;i<c.subtopics.length;i++)h(g,c.subtopics[i])}},i=a('<ul class="tree root-level"></ul>'),j=0;j<g.topics.length;j++)h(i,g.topics[j]);var k=a('<div class="operations main"><span data-action="toadd">&#10010;</span></div>');a(f.containerSelector).append(k),a(f.containerSelector).append(i),a(f.containerSelector).find("[data-action]").on("click",function(){var b=a(this);f.runAction(b.attr("data-action"),b.parent().parent())})}return!0}catch(l){return c.alert(b.get_string("error","core"),l),!1}}return!1},f.changeTopic=function(){var a=h.getBody();""!==a.find("#select_topic").val()?a.find("#url_text").attr("disabled","disabled"):a.find("#url_text").removeAttr("disabled")},f.saveTreeConfig=function(){var b={topics:[]};b.topics=f.treeNode2Object(a(f.containerSelector)),b.topics.length>0?a(f.codeSelector).val(JSON.stringify(b)):a(f.codeSelector).val("")},f.treeNode2Object=function(b){var c=[];return b.children("ul").children("li").each(function(b,d){var e=a(d),g={name:e.find("input").val(),subtopics:f.treeNode2Object(e),topicnumber:e.data("topic"),url:e.data("url"),target:e.data("target")};c[c.length]=g}),c},f});