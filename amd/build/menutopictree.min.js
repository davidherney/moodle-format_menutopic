define(["jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(e,t,a,n,r){var o={codeSelector:"#id_treecode",containerSelector:"#treecontainer"},i=[],c=null,d=null;return o.init=function(){var a=o.loadTreeAria(),l=[{key:"new"},{key:"delete"},{key:"actiondeleteconfirm_sheet_sheetedit",component:"format_menutopic"},{key:"yes"},{key:"no"},{key:"update"}];if(e.each(l,function(e,t){i[t.key]="..."}),t.get_strings(l).done(function(t){e.each(l,function(e,a){i[a.key]=t[e]})}),a){var p=e("#editsheetform").html();return n.create({type:n.types.SAVE_CANCEL,title:i.update,body:p}).done(function(e){var t=e.getBody();t.find("#select_topic").on("change",o.changeTopic),e.getRoot().on(r.save,function(){d.find(">input").val(t.find("#name_text").val()),d.data("topic",t.find("#select_topic").val()),d.data("url",t.find("#url_text").val()),d.data("target",t.find("#select_target").val())}),c=e}),e("#id_submitbutton").on("click",o.saveTreeConfig),!0}return!1},o.runAction=function(t,n){var r,l;switch(t){case"toleft":var p=n.parents("li:first");p.after(n),0==(r=p.children("ul")).children()&&r.remove();break;case"toright":0==(r=(l=n.prev("li")).children("ul")).length&&(r=e('<ul role="group"></ul>'),l.append(r)),r.append(n);break;case"todown":n.next("li").after(n);break;case"toup":(l=n.prev("li")).before(n);break;case"toremove":a.confirm(i.delete,i.actiondeleteconfirm_sheet_sheetedit,i.yes,i.no,function(){n.remove()});break;case"toadd":var s={name:i.new,topicnumber:0,url:"",target:""},u=o.newTreeNode(s,"");u.find("[data-action]").on("click",function(){var t=e(this);o.runAction(t.attr("data-action"),t.parent().parent())}),0==(r=n.children("ul")).length&&(r=e('<ul role="group"></ul>'),n.append(r)),r.append(u);break;case"toedit":if(d=n,c){var f=c.getBody();f.find("#name_text").val(n.find("input").val()),f.find("#select_topic").val(n.data("topic")),f.find("#url_text").val(n.data("url")),f.find("#select_target").val(n.data("target")),o.changeTopic(),c.setTitle(i.update),c.show()}}},o.newTreeNode=function(t){var a=e('<li><input value="'+t.name+'"/><div class="operations"><span data-action="toedit">&#9997;</span><span data-action="toleft">&larr;</span><span data-action="toright">&rarr;</span><span data-action="toup">&uarr;</span><span data-action="todown">&darr;</span><span data-action="toremove">&#10008;</span><span data-action="toadd">&#10010;</span></div></li>');return a.data("topic",t.topicnumber),a.data("url",t.url),a.data("target",t.target),a},o.loadTreeAria=function(){var n=e(o.codeSelector);if(n.length>0){var r=n.val();try{var i=JSON.parse(r);if(i.topics&&i.topics.length>0){for(var c=function(t,a){var n=!1;a.subtopics&&a.subtopics.length>0&&(n=!0);var r=o.newTreeNode(a);if(t.append(r),n){var i=e("<ul></ul>");r.append(i);for(var d=0;d<a.subtopics.length;d++)c(i,a.subtopics[d])}},d=e('<ul class="tree root-level"></ul>'),l=0;l<i.topics.length;l++)c(d,i.topics[l]);var p=e('<div class="operations main"><span data-action="toadd">&#10010;</span></div>');e(o.containerSelector).append(p),e(o.containerSelector).append(d),e(o.containerSelector).find("[data-action]").on("click",function(){var t=e(this);o.runAction(t.attr("data-action"),t.parent().parent())})}return!0}catch(e){return a.alert(t.get_string("error","core"),e),!1}}return!1},o.changeTopic=function(){var e=c.getBody();""!==e.find("#select_topic").val()?e.find("#url_text").attr("disabled","disabled"):e.find("#url_text").removeAttr("disabled")},o.saveTreeConfig=function(){var t={topics:[]};t.topics=o.treeNode2Object(e(o.containerSelector)),t.topics.length>0?e(o.codeSelector).val(JSON.stringify(t)):e(o.codeSelector).val("")},o.treeNode2Object=function(t){var a=[];return t.children("ul").children("li").each(function(t,n){var r=e(n),i={name:r.find("input").val(),subtopics:o.treeNode2Object(r),topicnumber:r.data("topic"),url:r.data("url"),target:r.data("target")};a[a.length]=i}),a},o});
