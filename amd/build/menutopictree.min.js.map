{"version":3,"file":"menutopictree.min.js","sources":["../src/menutopictree.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript library for the menutopic course format.\n *\n * @copyright 2018 David Herney Bernal - cirano\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport Notification from 'core/notification';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Log from 'core/log';\n\n/**\n * Local controller.\n */\nvar treeController = {\n    \"codeSelector\": '#id_treecode',\n    \"containerSelector\": '#treecontainer'\n};\n\nvar s = [];\n\nvar $editWindow = null;\n\nvar $currentNode = null;\n\ntreeController.runAction = function(action, $node) {\n    var $group;\n    var $prev;\n    switch (action) {\n        case 'toleft':\n            var $parent = $node.parents('li:first');\n            $parent.after($node);\n\n            $group = $parent.children('ul');\n            if ($group.children() == 0) {\n                $group.remove();\n            }\n\n            break;\n        case 'toright':\n            $prev = $node.prev('li');\n            $group = $prev.children('ul');\n            if ($group.length == 0) {\n                $group = $('<ul role=\"group\"></ul>');\n                $prev.append($group);\n            }\n\n            $group.append($node);\n\n            break;\n        case 'todown':\n            var $next = $node.next('li');\n            $next.after($node);\n\n            break;\n        case 'toup':\n            $prev = $node.prev('li');\n            $prev.before($node);\n\n            break;\n        case 'toremove':\n            Notification.confirm(s.delete, s.actiondeleteconfirm_sheet_sheetedit, s.yes, s.no,\n                function() {\n                    $node.remove();\n                }\n            );\n\n            break;\n        case 'toadd':\n            var obj = {\n                'name': s.new,\n                'topicnumber': 0,\n                'url': '',\n                'target': ''\n            };\n\n            var $newNode = treeController.newTreeNode(obj, '');\n            $newNode.find('[data-action]').on('click', function() {\n                var $this = $(this);\n                treeController.runAction($this.attr('data-action'), $this.parent().parent());\n            });\n\n            $group = $node.children('ul');\n            if ($group.length == 0) {\n                $group = $('<ul role=\"group\"></ul>');\n                $node.append($group);\n            }\n\n            $group.append($newNode);\n\n            break;\n        case 'toedit':\n\n            $currentNode = $node;\n\n            if ($editWindow) {\n                var $modalBody = $editWindow.getBody();\n                $modalBody.find('#name_text').val($node.find('input').val());\n                $modalBody.find('#select_topic').val($node.data('topic'));\n                $modalBody.find('#url_text').val($node.data('url'));\n                $modalBody.find('#select_target').val($node.data('target'));\n\n                treeController.changeTopic();\n\n                $editWindow.setTitle(s.update);\n                $editWindow.show();\n            }\n\n            break;\n    }\n};\n\ntreeController.newTreeNode = function(obj) {\n    // scape obj.name for html attribute\n    var name = obj.name.replace(/\"/g, '&quot;');\n\n    var $node = $('<li>' +\n                    '<input value=\"' + name + '\"/>' +\n                    '<div class=\"operations\">' +\n                        '<span data-action=\"toedit\">&#9997;</span>' +\n                        '<span data-action=\"toleft\">&larr;</span>' +\n                        '<span data-action=\"toright\">&rarr;</span>' +\n                        '<span data-action=\"toup\">&uarr;</span>' +\n                        '<span data-action=\"todown\">&darr;</span>' +\n                        '<span data-action=\"toremove\">&#10008;</span>' +\n                        '<span data-action=\"toadd\">&#10010;</span>' +\n                    '</div>' +\n                '</li>');\n    $node.data('topic', obj.topicnumber);\n    $node.data('url', obj.url);\n    $node.data('target', obj.target);\n\n    return $node;\n};\n\ntreeController.loadTreeAria = function() {\n    var $controlContainer = $(treeController.codeSelector);\n    if ($controlContainer.length > 0) {\n        var jsonString = $controlContainer.val();\n        try {\n            var jsonObject = JSON.parse(jsonString);\n            if (jsonObject.topics && jsonObject.topics.length > 0) {\n\n                var createNode = function($nodeRoot, obj) {\n                    var isparent = false;\n\n                    if (obj.subtopics && obj.subtopics.length > 0) {\n                        isparent = true;\n                    }\n\n                    var $node = treeController.newTreeNode(obj);\n\n                    $nodeRoot.append($node);\n\n                    if (isparent) {\n                        var $group = $('<ul></ul>');\n                        $node.append($group);\n                        for (var i = 0; i < obj.subtopics.length; i++) {\n                            createNode($group, obj.subtopics[i]);\n                        }\n                    }\n                };\n\n                var $treeAria = $('<ul class=\"tree root-level\"></ul>');\n\n                for (var i = 0; i < jsonObject.topics.length; i++) {\n                    createNode($treeAria, jsonObject.topics[i]);\n                }\n\n                var $operations = $('<div class=\"operations main\">' +\n                                    '<span data-action=\"toadd\">&#10010;</span>' +\n                                '</div>');\n                $(treeController.containerSelector).append($operations);\n\n                $(treeController.containerSelector).append($treeAria);\n\n                $(treeController.containerSelector).find('[data-action]').on('click', function() {\n                    var $this = $(this);\n                    treeController.runAction($this.attr('data-action'), $this.parent().parent());\n                });\n            }\n\n            return true;\n        } catch (e) {\n            getString('error', 'core').then(str => {\n                Notification.alert(str, e);\n            });\n            return false;\n        }\n    }\n\n    return false;\n};\n\ntreeController.changeTopic = function() {\n\n    var $modalBody = $editWindow.getBody();\n    if ($modalBody.find('#select_topic').val() !== \"\") {\n        $modalBody.find('#url_text').attr('disabled', 'disabled');\n    } else {\n        $modalBody.find('#url_text').removeAttr('disabled');\n    }\n};\n\ntreeController.saveTreeConfig = function() {\n\n    var treecode = {\n        \"topics\": []\n    };\n\n    treecode.topics = treeController.treeNode2Object($(treeController.containerSelector));\n\n    if (treecode.topics.length > 0) {\n        $(treeController.codeSelector).val(JSON.stringify(treecode));\n    } else {\n        $(treeController.codeSelector).val('');\n    }\n};\n\ntreeController.treeNode2Object = function($nodeRoot) {\n    var nodes = [];\n    $nodeRoot.children('ul').children('li').each(function(key, node) {\n        var $node = $(node);\n\n        var name = $node.find('input').val();\n\n        var onenode = {\n            \"name\": name,\n            \"subtopics\": treeController.treeNode2Object($node),\n            \"topicnumber\": $node.data('topic'),\n            \"url\": $node.data('url'),\n            \"target\": $node.data('target')\n        };\n\n        nodes[nodes.length] = onenode;\n\n    });\n\n    return nodes;\n};\n\n/**\n * Component initialization.\n *\n * @method init\n */\nexport const init = () => {\n\n    var loaded = treeController.loadTreeAria();\n\n    // Load strings.\n    var strings = [];\n    strings.push({key: 'actiondeleteconfirm_sheet_sheetedit', component: 'format_menutopic'});\n    strings.push({key: 'new', component: 'core'});\n    strings.push({key: 'delete', component: 'core'});\n    strings.push({key: 'yes', component: 'core'});\n    strings.push({key: 'no', component: 'core'});\n    strings.push({key: 'update', component: 'core'});\n\n    strings.forEach(one => {\n        s[one.key] = one.key;\n    });\n\n    getStrings(strings).then(function(results) {\n        var pos = 0;\n        strings.forEach(one => {\n            s[one.key] = results[pos];\n            pos++;\n        });\n        return true;\n    }).fail(function(e) {\n        Log.debug('Error loading strings');\n        Log.debug(e);\n    });\n    // End of Load strings.\n\n    if (loaded) {\n\n        var editBody = $('#editsheetform').html();\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: s.update,\n            body: editBody\n        })\n        .done(function(modal) {\n            var $modalBody = modal.getBody();\n            $modalBody.find('#select_topic').on('change', treeController.changeTopic);\n            modal.getRoot().on(ModalEvents.save, function() {\n                $currentNode.find('>input').val($modalBody.find('#name_text').val());\n                $currentNode.data('topic', $modalBody.find('#select_topic').val());\n                $currentNode.data('url', $modalBody.find('#url_text').val());\n                $currentNode.data('target', $modalBody.find('#select_target').val());\n            });\n            $editWindow = modal;\n        });\n\n        $('#id_submitbutton').on('click', treeController.saveTreeConfig);\n\n    }\n};\n"],"names":["treeController","s","$editWindow","$currentNode","runAction","action","$node","$group","$prev","$parent","parents","after","children","remove","prev","length","append","next","before","confirm","delete","actiondeleteconfirm_sheet_sheetedit","yes","no","obj","new","$newNode","newTreeNode","find","on","$this","this","attr","parent","$modalBody","getBody","val","data","changeTopic","setTitle","update","show","name","replace","topicnumber","url","target","loadTreeAria","$controlContainer","codeSelector","jsonString","jsonObject","JSON","parse","topics","createNode","$nodeRoot","isparent","subtopics","i","$treeAria","$operations","containerSelector","e","then","str","alert","removeAttr","saveTreeConfig","treecode","treeNode2Object","stringify","nodes","each","key","node","onenode","loaded","strings","push","component","forEach","one","results","pos","fail","debug","editBody","html","create","type","ModalFactory","types","SAVE_CANCEL","title","body","done","modal","getRoot","ModalEvents","save"],"mappings":"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"}